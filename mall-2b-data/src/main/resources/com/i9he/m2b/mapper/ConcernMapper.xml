<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.i9he.m2b.mapper.ConcernMapper" >
  <resultMap id="BaseResultMap" type="com.i9he.m2b.model.Concern" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="user_id" property="userId" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="price" property="price" jdbcType="DECIMAL" />
    <result column="remind_status" property="remindStatus" jdbcType="TINYINT" />
    <result column="expect_ price" property="expectPrice" jdbcType="DECIMAL" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <association property="goods" column="goods_id" select="com.i9he.m2b.mapper.Goods2bMapper.selectByPrimaryKey" />
  </resultMap>
  
  
<resultMap id="InterestedModelResult" type="com.i9he.m2b.model.InterestedModel" >
    <result column="create_dateStr" property="dataStr"  />
    <result column="userSum" property="interestedNumber"  />
</resultMap>
  
  <resultMap type="com.i9he.m2b.model.RemindInfo" id="RemindResultMap">
    <result column="id" property="concernId"/>
    <result column="user_id" property="userId"/>
    <result column="goods_id" property="goodsId"/>
    <result column="username" property="userName"/>
  	<result column="email" property="email"  />
    <result column="mobile" property="phone"  />
    <result column="goods_name" property="goodsName" />
    <result column="goods_img" property="goodsImg"/>
    <result column="goods_price" property="price" jdbcType="DECIMAL" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    id, user_id, `status`, price, remind_status, `expect_ price`, create_time
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    select 
    <include refid="Base_Column_List" />
    from b2b_concern
    where id = #{id,jdbcType=INTEGER}
  </select>
  <insert id="insert" parameterType="com.i9he.m2b.model.Concern" useGeneratedKeys="true" keyProperty="id" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    insert into b2b_concern (user_id, goods_id, `status`, 
      price, remind_status, `expect_ price`, 
      create_time)
    values (#{userId,jdbcType=INTEGER}, #{goodsId,jdbcType=INTEGER}, #{status,jdbcType=TINYINT}, 
      #{price,jdbcType=DECIMAL}, #{remindStatus,jdbcType=TINYINT}, #{expectPrice,jdbcType=DECIMAL}, 
      #{createTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.i9he.m2b.model.Concern" useGeneratedKeys="true" keyProperty="id" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    insert into b2b_concern
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="userId != null" >
        user_id,
      </if>
      <if test="goodsId != null" >
        goods_id,
      </if>
      <if test="status != null" >
        `status`,
      </if>
      <if test="price != null" >
        price,
      </if>
      <if test="remindStatus != null" >
        remind_status,
      </if>
      <if test="expectPrice != null" >
        `expect_ price`,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="userId != null" >
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="goodsId != null" >
        #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
      <if test="price != null" >
        #{price,jdbcType=DECIMAL},
      </if>
      <if test="remindStatus != null" >
        #{remindStatus,jdbcType=TINYINT},
      </if>
      <if test="expectPrice != null" >
        #{expectPrice,jdbcType=DECIMAL},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.i9he.m2b.model.Concern" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    update b2b_concern
    <set >
      <if test="userId != null" >
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="goodsId != null" >
        goods_id = #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        `status` = #{status,jdbcType=TINYINT},
      </if>
      <if test="price != null" >
        price = #{price,jdbcType=DECIMAL},
      </if>
      <if test="remindStatus != null" >
        remind_status = #{remindStatus,jdbcType=TINYINT},
      </if>
      <if test="expectPrice != null" >
        `expect_ price` = #{expectPrice,jdbcType=DECIMAL},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.i9he.m2b.model.Concern" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    update b2b_concern
    set user_id = #{userId,jdbcType=INTEGER},
      goods_id = #{goodsId,jdbcType=INTEGER},
      `status` = #{status,jdbcType=TINYINT},
      price = #{price,jdbcType=DECIMAL},
      remind_status = #{remindStatus,jdbcType=TINYINT},
      `expect_ price` = #{expectPrice,jdbcType=DECIMAL},
      create_time = #{createTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <!-- <include refid="Base_Column_List"></include> -->
  <!-- 获取关注列表 -->
  <select id="getConcernGoodsList" parameterType="com.i9he.m2b.model.search.ConcernSearchModel" resultMap="BaseResultMap">
  	select *
  	from b2b_concern
  	<where>
  	    is_del = 0
  		<if test="userId!=null">
  		and	user_id=#{userId}
  		</if>
  		<if test="status!=null">
  		and	status = #{status}
  		</if>
  	</where>
  	order by create_time desc
  </select>
  <!-- 获取关注总数 -->
  <select id="getTotal" parameterType="com.i9he.m2b.model.search.ConcernSearchModel" resultType="Integer">
  	select count(1) from b2b_concern 
  	<where>
  	    is_del =0
  		<if test="userId!=null">
  		 and user_id=#{userId}
  		</if>
  		<if test="status!=null">
  		and status = #{status}
  		</if>
  	</where>
  </select>
  <!--需要降价通知的商品  -->
  <select id="getRemindList" resultMap="RemindResultMap">
  	select  
	c.id,c.`user_id`,u.`username`,u.`email`,u.`mobile`,g.`goods_name`,g.`goods_price`,g.`goods_img`,c.goods_id
    from b2b_concern c 
	left join b2b_goods g on c.goods_id=g.id
	left join usr_user u on c.`user_id` = u.`id`
	where c.`expect_ price` &gt; g.`goods_price`
	and c.status= 1
	and c.remind_status=1
	and is_del = 0 
  </select>
  <!--是否已关注 -->
  <select id="isConcern" parameterType="com.i9he.m2b.model.Concern" resultMap="BaseResultMap" >
  		select 
  		<include refid="Base_Column_List" />
  		from b2b_concern 
  		where user_id = #{userId} 
  		and goods_id = #{goodsId}
  		and status = 1
  		and is_del=0
  </select>
  <!-- 是否降价提醒 -->
  <select id="isRemind" parameterType="com.i9he.m2b.model.Concern" resultMap="BaseResultMap" >
  		select 
  		<include refid="Base_Column_List" />
  		from b2b_concern 
  		where user_id = #{userId} 
  		and goods_id = #{goodsId}
  		and status = 1
  		and remind_status=1
  		and is_del=0
  </select>
  
  <!-- 关注总数 -->
  <select id="concernCount" parameterType="Integer" resultType="Integer">
  	select count(*) from b2b_concern
  	where 
  	is_del =0 and 
  	user_id=#{userId} and 
  	status =1
  </select>
  
  <select id="getInterestedModel" resultMap="InterestedModelResult">
  		SET @add_sal=0;
		SELECT create_dateStr,userCount,@add_sal :=@add_sal+f.userCount AS userSum FROM
		(SELECT DATE_FORMAT(`create_time`,'%Y年%m月') AS create_dateStr,COUNT(*) AS userCount  FROM `b2b_concern` GROUP BY DATE_FORMAT(`create_time`,'%Y年%m月'))
		f  ORDER BY  create_dateStr DESC,userSum DESC  LIMIT 0,5
  </select>
</mapper>