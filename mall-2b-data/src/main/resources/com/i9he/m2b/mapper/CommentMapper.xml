<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.i9he.m2b.mapper.CommentMapper" >
  <resultMap id="BaseResultMap" type="com.i9he.m2b.model.Comment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="goods_id" property="goodsId" jdbcType="INTEGER" />
    <result column="user_id" property="userId" jdbcType="INTEGER" />
    <result column="order_id" property="orderId" jdbcType="INTEGER" />
    <result column="photo" property="photo" jdbcType="VARCHAR" />
    <result column="overall_comment" property="overallComment" jdbcType="INTEGER" />
    <result column="goods_satisfied" property="goodsSatisfied" jdbcType="INTEGER" />
    <result column="comment_date" property="commentDate" jdbcType="TIMESTAMP" />
    <result column="reply_date" property="replyDate" jdbcType="TIMESTAMP" />
    <result column="is_del" property="isDel" jdbcType="BIT" />
    <result column="ord_order.created_date" property="createdDate" jdbcType="TIMESTAMP" />
    <result column="amount" property="amount" jdbcType="DECIMAL" />
    <result column="count" property="count" jdbcType="INTEGER" />
    <result column="goods_img" property="goodsImage" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap type="com.i9he.m2b.model.CommentViewModel" id="CommentResult">
  		<result column="name" property="name"  />
        <result column="goodsNumber" property="goodsNumber"  />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.i9he.m2b.model.Comment" extends="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    <result column="content" property="content" jdbcType="LONGVARCHAR" />
    <result column="reply_content" property="replyContent" jdbcType="LONGVARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    b.id, b.goods_id, b.user_id, b.order_id, photo, overall_comment, goods_satisfied, comment_date, reply_date, is_del
  </sql>
  <sql id="Blob_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    content, reply_content
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from b2b_comment as b
    where id = #{id,jdbcType=INTEGER}
  </select>
  <insert id="insert" parameterType="com.i9he.m2b.model.Comment" useGeneratedKeys="true" keyProperty="id" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    insert into b2b_comment (goods_id, user_id, order_id, photo, 
      overall_comment, goods_satisfied, comment_date, 
      reply_date, is_del,content, reply_content
      )
    values (#{goodsId,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{orderId,jdbcType=INTEGER}, #{photo,jdbcType=VARCHAR}, 
      #{overallComment,jdbcType=INTEGER}, #{goodsSatisfied,jdbcType=INTEGER}, #{commentDate,jdbcType=TIMESTAMP}, 
      #{replyDate,jdbcType=TIMESTAMP},#{isDel,jdbcType=BIT}, #{content,jdbcType=LONGVARCHAR}, #{replyContent,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.i9he.m2b.model.Comment" useGeneratedKeys="true" keyProperty="id" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    insert into b2b_comment
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="goodsId != null" >
        goods_id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="orderId != null" >
        order_id,
      </if>
      <if test="photo != null" >
        photo,
      </if>
      <if test="overallComment != null" >
        overall_comment,
      </if>
      <if test="goodsSatisfied != null" >
        goods_satisfied,
      </if>
      <if test="commentDate != null" >
        comment_date,
      </if>
      <if test="replyDate != null" >
        reply_date,
      </if>
      <if test="isDel != null" >
        is_del,
      </if>
      <if test="content != null" >
        content,
      </if>
      <if test="replyContent != null" >
        reply_content,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="goodsId != null" >
        #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="orderId != null" >
        #{orderId,jdbcType=INTEGER},
      </if>
      <if test="photo != null" >
        #{photo,jdbcType=VARCHAR},
      </if>
      <if test="overallComment != null" >
        #{overallComment,jdbcType=INTEGER},
      </if>
      <if test="goodsSatisfied != null" >
        #{goodsSatisfied,jdbcType=INTEGER},
      </if>
      <if test="commentDate != null" >
        #{commentDate,jdbcType=TIMESTAMP},
      </if>
      <if test="replyDate != null" >
        #{replyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null" >
        #{isDel,jdbcType=BIT},
      </if>
      <if test="content != null" >
        #{content,jdbcType=LONGVARCHAR},
      </if>
      <if test="replyContent != null" >
        #{replyContent,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.i9he.m2b.model.Comment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    update b2b_comment
    <set >
      <if test="goodsId != null" >
        goods_id = #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="userId != null" >
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="orderId != null" >
        order_id = #{orderId,jdbcType=INTEGER},
      </if>
      <if test="photo != null" >
        photo = #{photo,jdbcType=VARCHAR},
      </if>
      <if test="overallComment != null" >
        overall_comment = #{overallComment,jdbcType=INTEGER},
      </if>
      <if test="goodsSatisfied != null" >
        goods_satisfied = #{goodsSatisfied,jdbcType=INTEGER},
      </if>
      <if test="commentDate != null" >
        comment_date = #{commentDate,jdbcType=TIMESTAMP},
      </if>
      <if test="replyDate != null" >
        reply_date = #{replyDate,jdbcType=TIMESTAMP},
      </if>
      <if test="isDel != null" >
        is_del = #{isDel,jdbcType=BIT},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=LONGVARCHAR},
      </if>
      <if test="replyContent != null" >
        reply_content = #{replyContent,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.i9he.m2b.model.Comment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    update b2b_comment
    set goods_id = #{goodsId,jdbcType=INTEGER},
      user_id = #{userId,jdbcType=INTEGER},
      order_id = #{orderId,jdbcType=INTEGER},
      photo = #{photo,jdbcType=VARCHAR},
      overall_comment = #{overallComment,jdbcType=INTEGER},
      goods_satisfied = #{goodsSatisfied,jdbcType=INTEGER},
      comment_date = #{commentDate,jdbcType=TIMESTAMP},
      reply_date = #{replyDate,jdbcType=TIMESTAMP},
      is_del = #{isDel,jdbcType=BIT},
      content = #{content,jdbcType=LONGVARCHAR},
      reply_content = #{replyContent,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.i9he.m2b.model.Comment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      copyright@ www.9he.com
    -->
    update b2b_comment
    set goods_id = #{goodsId,jdbcType=INTEGER},
      user_id = #{userId,jdbcType=INTEGER},
      order_id = #{orderId,jdbcType=INTEGER},
      photo = #{photo,jdbcType=VARCHAR},
      overall_comment = #{overallComment,jdbcType=INTEGER},
      goods_satisfied = #{goodsSatisfied,jdbcType=INTEGER},
      comment_date = #{commentDate,jdbcType=TIMESTAMP},
      reply_date = #{replyDate,jdbcType=TIMESTAMP},
      is_del = #{isDel,jdbcType=BIT}
    where id = #{id,jdbcType=INTEGER}
  </update>
  
  <select id="selectByUser" resultMap="ResultMapWithBLOBs" parameterType="com.i9he.m2b.model.Comment" >
    select 
    o.created_date,
    amount,count,goods_img,
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from b2b_comment as b
    left join ord_order as o on b.order_id = o.id
    left join ord_goods as og on b.order_id = og.order_id
    left join b2b_goods as bg on b.goods_id = bg.id
    where b.user_id = #{userId,jdbcType=INTEGER} AND is_del = 0
    order by comment_date desc
  	limit #{offset}, #{pageSize}
  </select>
  <select id="selectCount" resultType="java.lang.Integer" parameterType="com.i9he.m2b.model.Comment" >
    select 
	count(1)
    from b2b_comment as b where is_del = 0
    <if test="userId != null">
  		and user_id = #{userId,jdbcType=INTEGER}
  	</if>
  </select>
  
  <select id="selectAllComment" resultMap="ResultMapWithBLOBs" parameterType="com.i9he.m2b.model.Comment" >
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from b2b_comment as b where is_del = 0
   <if test="overallComment != null">
  		and overall_comment = #{overallComment,jdbcType=INTEGER}
  	</if>
   <if test="isReply == true">
  		 and reply_date IS NOT NULL
  	</if>
   <if test="goodsId != null">
  		and goods_id = #{goodsId,jdbcType=INTEGER}
  	</if>
   <if test="photo != null">
  		and NULLIF(photo,'') != ''
  	</if>
    order by comment_date desc
  	limit #{offset}, #{pageSize}
  </select>
  <select id="selectAllCount" resultType="java.lang.Integer" parameterType="com.i9he.m2b.model.Comment" >
    select 
	count(1)
    from b2b_comment where is_del = 0
    <if test="overallComment != null">
  		and overall_comment = #{overallComment,jdbcType=INTEGER}
  	</if>
   <if test="isReply == true">
  		 and reply_date IS NOT NULL
  	</if>
  	<if test="goodsId != null">
  		and goods_id = #{goodsId,jdbcType=INTEGER}
  	</if>
  	<if test="photo != null">
  		and NULLIF(photo,'') != ''
  	</if>
  </select>
  
  <select id="selectByOrderId" parameterType="java.lang.Integer" resultMap="ResultMapWithBLOBs">
  	select
  	<include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from b2b_comment as b 
    where is_del = 0 and order_id = #{orderId,jdbcType=INTEGER}
  </select>
  
  <select id="getCommentRankData" resultMap="CommentResult">
  		select `b2b_goods`.`goods_name` as `name`,f.goodsNumber from (
			SELECT `goods_id`,COUNT(1) AS goodsNumber FROM `b2b_comment`
			where `overall_comment`=2
			GROUP BY `goods_id` ORDER BY goodsNumber DESC LIMIT 0,10
		) f  left join `b2b_goods` on f.`goods_id` = `b2b_goods`.`id`
  </select>
</mapper>